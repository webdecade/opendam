var mapL = "";
var dC = 0;
var find = false;
var marker = "";
var c = 0;

function showL(object_id, center_lat, center_lng, sw_lat, sw_lng, ne_lat, ne_lng, type)
{
	mapL = L.map(object_id).setView([center_lat, center_lng], 10);

	L.tileLayer('http://{s}.tile.cloudmade.com/' + L_key + '/997/256/{z}/{x}/{y}.png', {
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
	}).addTo(mapL);

	mapL.fitBounds([
		[parseFloat(sw_lat), parseFloat(sw_lng)],
		[parseFloat(ne_lat), parseFloat(ne_lng)]
	]);

	mapL.on('dblclick', function(event) {
		mapL.zoomIn();
	});

	mapL.on('contextmenu', function(event) {
		find = true;
	});

	mapL.on('mousedown', function(event) {

		if(find)
		{
			dC++;
			setTimeout(initContextmenu, 600);
		}

		if (dC >1)
			mapL.zoomOut();

		find = false;
	});

	var queryString = 'southLat=' + sw_lat + '&northLat=' + ne_lat + '&southLng=' + sw_lng + '&northLng=' + ne_lng;

	switch(type)
	{
		case 'file':
			jQuery("#map_indicator").show();
			jQuery.post(
				'/map/files?'+queryString,
				function(data) {
					jQuery("#result").html(data);
					jQuery("#map_indicator").hide();
				}
			);
		break;

		case 'folder':
			jQuery("#map_indicator").show();
			jQuery.post(
				'/map/folders?'+queryString,
				function(data) {
					jQuery("#result").html(data);
					jQuery("#map_indicator").hide();
				}
			);
		break;
	}
}

function initializeL(object_id, address, lat, lng, bind)
{
	if(address)
	{
		jQuery.get(
			'http://nominatim.openstreetmap.org/search/',
			{ format: "json", bounded: 1, q: address },
			function(data) {
				mapL = L.map(object_id).setView([data[0].lat, data[0].lon], 10);

				processInitializeL(bind);
			},
			'json'
		);
	}
	else if(lat && lng)
	{
		mapL = L.map(object_id).setView([lat, lng], 10);
		marker = L.marker([lat, lng]).addTo(mapL);

		processInitializeL(bind);
	}
	else
	{
		mapL = L.map(object_id).setView([48.856667, 2.335987], 10);

		processInitializeL(bind);
	}
}

function processInitializeL(bind)
{
	L.tileLayer('http://{s}.tile.cloudmade.com/' + L_key + '/997/256/{z}/{x}/{y}.png', {
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
	}).addTo(mapL);

	mapL.on('dblclick', function(event) {
		mapL.zoomIn();
	});

	mapL.on('contextmenu', function(event) {
		find = true;
	});

	mapL.on('mousedown', function(event) {
		if(find)
		{
			dC++;
			setTimeout(initContextmenu, 500);
		}

		if (dC > 1)
			mapL.zoomOut();

		find = false;
	});

	switch(bind)
	{
		case "add":
		{
			var clickCount = 0;

			mapL.on('click', function(event) {
				clickCount += 1;
				if (clickCount <= 1)
				{
					window.setTimeout(function() {
						if (clickCount <= 1)
						{
							if(marker)
								mapL.removeLayer(marker);

							marker = L.marker([event.latlng.lat, event.latlng.lng]).addTo(mapL);

							marker.on('dblclick', function(event) {
								mapL.removeLayer(marker);
							});

							jQuery('#lat').val(event.latlng.lat);
							jQuery('#lng').val(event.latlng.lng);
						}

						clickCount = 0;
					}, 500);
				}
			});
		}
		break;
	}
}

function searchLocationL(address)
{
	jQuery.post(
		'/map/searchLocation',
		{ format: "json", address: address },
		function(data) {
			if(marker)
				mapL.removeLayer(marker);

			marker = L.marker([data[0].lat, data[0].lon]).addTo(mapL);

			marker.on('dblclick', function(event) {
				mapL.removeLayer(marker);
			});

			jQuery('#lat').val(data[0].lat);
			jQuery('#lng').val(data[0].lon);

			mapL.panTo([data[0].lat, data[0].lon]);
		},
		'json'
	);
}

function createShowMarkerL(lat, lng, info)
{
	var mark = L.marker([lat, lng]).addTo(mapL);
	mark.bindPopup(info).openPopup();
}

function initContextmenu()
{
	dC = 0;
}